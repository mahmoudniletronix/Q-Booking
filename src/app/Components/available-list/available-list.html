<div class="available-page">
  <div class="container">
    <!-- Header -->
    <div class="page-header d-flex align-items-center justify-content-between mb-4 flex-wrap">
      <button class="btn-back" (click)="back()">‚Ü©</button>
      <div class="text-center flex-grow-1">
        <h4 class="title mb-1">Available ‚Äî {{ dayName }} {{ day }}</h4>
        <div class="sub">Pick a time slot and complete the reservation details.</div>
      </div>
    </div>

    <div class="row justify-content-center align-items-start layout-row">
      <div class="col-lg-9 col-md-7 mb-4 mb-md-0">
        <div *ngIf="loading" class="text-center py-4 text-muted">Loading slots...</div>

        <div class="avail-grid" *ngIf="!loading && slots.length; else noSlots">
          <div
            class="avail-card"
            *ngFor="let s of slots; trackBy: trackBySlot"
            (click)="!isReserved(s) && onSlotClick(s)"
            [class.active]="selectedSlot?.index === s.index"
            [class.reserved]="isReserved(s)"
          >
            <div class="card-top">
              <span class="time">{{ formatTime(s.timeSlot) }}</span>
              <span class="type-chip" [ngClass]="isReserved(s) ? 'reserved' : 'available'">
                {{ isReserved(s) ? 'Reserved' : 'Available' }}
              </span>
            </div>

            <div class="card-bottom">
              <ng-template #reservedInfo>
                <div class="reserved-label">
                  <span class="ico"></span>
                  {{ s.ticket?.patient || 'Booked' }}
                </div>
              </ng-template>
            </div>

            <div class="shine"></div>
          </div>
        </div>

        <ng-template #noSlots>
          <div class="empty-state text-center mt-3" *ngIf="!loading">
            <div class="emoji">üóìÔ∏è</div>
            <div class="lead fw-semibold">No available slots for this day.</div>
          </div>
        </ng-template>
      </div>

      <div class="col-lg-3 col-md-5">
        <!-- ====== Form ====== -->
        <div class="patient-form-page" *ngIf="selectedSlot; else detailsHint">
          <div class="patient-card shadow-lg border-0" #formCard>
            <div class="card-body p-3 p-md-4">
              <div class="form-header mb-3">
                <h5 class="form-title mb-1">
                  <span class="accent">
                    {{ mode === 'add' ? 'Add New Appointment' : 'Edit Appointment' }}
                  </span>
                </h5>
                <div class="slot-label">
                  <strong> Schedule: </strong>
                  <span class="muted">{{ day }} </span>
                  {{ formatTime(timeInfo) }}
                </div>
              </div>

              <form (ngSubmit)="save()" novalidate>
                <div class="mb-3">
                  <label class="form-label fw-semibold">Patient Name</label>
                  <input
                    type="text"
                    class="form-control"
                    [(ngModel)]="model.patient"
                    name="patient"
                    required
                    #patientInput
                  />
                </div>

                <div class="mb-3">
                  <label class="form-label fw-semibold">Phone</label>
                  <input
                    type="tel"
                    class="form-control"
                    [(ngModel)]="model.phone"
                    name="phone"
                    required
                  />
                </div>

                <div class="d-grid gap-2 mt-4">
                  <button
                    class="btn btn-primary action-btn"
                    type="submit"
                    [disabled]="!model.patient || !model.phone"
                  >
                    {{ mode === 'add' ? 'Add Appointment' : 'Save Changes' }}
                  </button>
                  <button
                    class="btn btn-outline-secondary"
                    type="button"
                    (click)="clearSelection()"
                  >
                    Cancel
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <ng-template #detailsHint>
          <div class="details-placeholder text-center text-muted">
            <div class="emoji"></div>
            <div class="mt-2">
              Select an available time slot on the left
              <br />
              to add appointment details here.
            </div>
          </div>
        </ng-template>

        <!-- ====== Summary ====== -->
        <div class="ticket-summary-card mt-3" *ngIf="lastCreatedTicket as t">
          <div class="card shadow-sm border-0">
            <div class="card-body p-3">
              <h6 class="mb-3 fw-semibold">Last created ticket</h6>

              <div class="summary-row d-flex justify-content-between mb-1">
                <span class="label text-muted">Number</span>
                <span class="value fw-semibold">{{ t.number }}</span>
              </div>

              <div class="summary-row d-flex justify-content-between mb-1">
                <span class="label text-muted">Patient</span>
                <span class="value">{{ t.patientName }}</span>
              </div>

              <div class="summary-row d-flex justify-content-between mb-1">
                <span class="label text-muted">Phone</span>
                <span class="value">{{ t.phoneNumber }}</span>
              </div>

              <div class="summary-row d-flex justify-content-between mb-1">
                <span class="label text-muted">Date</span>
                <span class="value">{{ summaryDate(t) }}</span>
              </div>

              <div class="summary-row d-flex justify-content-between mb-1">
                <span class="label text-muted">Time</span>
                <span class="value">{{ summaryTime(t) }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
