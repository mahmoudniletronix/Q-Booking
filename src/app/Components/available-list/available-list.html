<div class="available-page">
  <div class="container">
    <!-- Header -->
    <div class="page-header d-flex align-items-center justify-content-between mb-4 flex-wrap">
      <button class="btn-back" (click)="back()">â†©</button>
      <div class="text-center flex-grow-1">
        <h4 class="title mb-1">
          {{ isAr() ? 'Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­Ø© â€”' : 'Available â€”' }}
          {{ dayName }} {{ day }}
        </h4>
        <div class="sub">
          {{
            isAr()
              ? 'Ø§Ø®ØªØ± Ù…ÙˆØ¹Ø¯Ù‹Ø§ ÙˆØ£ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø².'
              : 'Pick a time slot and complete the reservation details.'
          }}
        </div>
      </div>
    </div>

    <div class="row justify-content-center align-items-start layout-row">
      <div class="col-lg-9 col-md-7 mb-4 mb-md-0">
        <div *ngIf="loading" class="text-center py-4 text-muted">
          {{ isAr() ? 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯...' : 'Loading slots...' }}
        </div>

        <div class="avail-grid" *ngIf="!loading && slots.length; else noSlots">
          <div
            class="avail-card"
            *ngFor="let s of slots; trackBy: trackBySlot"
            (click)="!isReserved(s) && onSlotClick(s)"
            [class.active]="selectedSlot?.index === s.index"
            [class.reserved]="isReserved(s)"
          >
            <div class="card-top">
              <span class="time">{{ formatTime(s.timeSlot) }}</span>
              <span class="type-chip" [ngClass]="isReserved(s) ? 'reserved' : 'available'">
                {{
                  isReserved(s) ? (isAr() ? 'Ù…Ø­Ø¬ÙˆØ²' : 'Reserved') : isAr() ? 'Ù…ØªØ§Ø­' : 'Available'
                }}
              </span>
            </div>

            <div class="card-bottom">
              <ng-template #reservedInfo>
                <div class="reserved-label">
                  <span class="ico"></span>
                  {{ s.ticket?.patient || (isAr() ? 'Ù…Ø­Ø¬ÙˆØ²' : 'Booked') }}
                </div>
              </ng-template>
            </div>

            <div class="shine"></div>
          </div>
        </div>

        <ng-template #noSlots>
          <div class="empty-state text-center mt-3" *ngIf="!loading">
            <div class="emoji">ğŸ—“ï¸</div>
            <div class="lead fw-semibold">
              {{ isAr() ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ù…ØªØ§Ø­Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ….' : 'No available slots for this day.' }}
            </div>
          </div>
        </ng-template>
      </div>

      <div class="col-lg-3 col-md-5">
        <!-- ====== Form ====== -->
        <div class="patient-form-page" *ngIf="selectedSlot; else detailsHint">
          <div class="patient-card shadow-lg border-0" #formCard>
            <div class="card-body p-3 p-md-4">
              <div class="form-header mb-3">
                <h5 class="form-title mb-1">
                  <span class="accent">
                    {{
                      mode === 'add'
                        ? isAr()
                          ? 'Ø¥Ø¶Ø§ÙØ© Ø­Ø¬Ø² Ø¬Ø¯ÙŠØ¯'
                          : 'Add New Appointment'
                        : isAr()
                        ? 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²'
                        : 'Edit Appointment'
                    }}
                  </span>
                </h5>
                <div class="slot-label">
                  <strong> {{ isAr() ? 'Ø§Ù„Ù…ÙˆØ¹Ø¯:' : 'Schedule:' }} </strong>
                  <span class="muted">{{ day }} </span>
                  {{ formatTime(timeInfo) }}
                </div>
              </div>

              <form (ngSubmit)="save()" novalidate>
                <div class="mb-3">
                  <label class="form-label fw-semibold">
                    {{ isAr() ? 'Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶' : 'Patient Name' }}
                  </label>
                  <input
                    type="text"
                    class="form-control"
                    [(ngModel)]="model.patient"
                    name="patient"
                    required
                    #patientInput
                  />
                </div>

                <div class="mb-3">
                  <label class="form-label fw-semibold">
                    {{ isAr() ? 'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„' : 'Phone' }}
                  </label>
                  <input
                    type="tel"
                    class="form-control"
                    [(ngModel)]="model.phone"
                    name="phone"
                    required
                  />
                </div>

                <div class="d-grid gap-2 mt-4">
                  <button
                    class="btn btn-primary action-btn"
                    type="submit"
                    [disabled]="!model.patient || !model.phone"
                  >
                    {{
                      mode === 'add'
                        ? isAr()
                          ? 'Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø¬Ø²'
                          : 'Add Appointment'
                        : isAr()
                        ? 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª'
                        : 'Save Changes'
                    }}
                  </button>
                  <button
                    class="btn btn-outline-secondary"
                    type="button"
                    (click)="clearSelection()"
                  >
                    {{ isAr() ? 'Ø¥Ù„ØºØ§Ø¡' : 'Cancel' }}
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <ng-template #detailsHint>
          <div class="details-placeholder text-center text-muted">
            <div class="emoji"></div>
            <div class="mt-2">
              {{
                isAr()
                  ? 'Ø§Ø®ØªØ± Ù…ÙˆØ¹Ø¯Ù‹Ø§ Ù…ØªØ§Ø­Ù‹Ø§ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø± Ù„Ø¥Ø¶Ø§ÙØ© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø² Ù‡Ù†Ø§.'
                  : 'Select an available time slot on the left to add appointment details here.'
              }}
            </div>
          </div>
        </ng-template>

        <!-- ====== Summary ====== -->
        <div class="ticket-summary-card mt-3" *ngIf="lastCreatedTicket as t">
          <div class="card shadow-sm border-0">
            <div class="card-body p-3">
              <h6 class="mb-3 fw-semibold">
                {{ isAr() ? 'Ø¢Ø®Ø± ØªØ°ÙƒØ±Ø© ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§' : 'Last created ticket' }}
              </h6>

              <div class="summary-row d-flex justify-content-between mb-1">
                <span class="label text-muted">
                  {{ isAr() ? 'Ø§Ù„Ø±Ù‚Ù…' : 'Number' }}
                </span>
                <span class="value fw-semibold">{{ t.number }}</span>
              </div>

              <div class="summary-row d-flex justify-content-between mb-1">
                <span class="label text-muted">
                  {{ isAr() ? 'Ø§Ù„Ù…Ø±ÙŠØ¶' : 'Patient' }}
                </span>
                <span class="value">{{ t.patientName }}</span>
              </div>

              <div class="summary-row d-flex justify-content-between mb-1">
                <span class="label text-muted">
                  {{ isAr() ? 'Ø§Ù„Ø¬ÙˆØ§Ù„' : 'Phone' }}
                </span>
                <span class="value">{{ t.phoneNumber }}</span>
              </div>

              <div class="summary-row d-flex justify-content-between mb-1">
                <span class="label text-muted">
                  {{ isAr() ? 'Ø§Ù„ØªØ§Ø±ÙŠØ®' : 'Date' }}
                </span>
                <span class="value">{{ summaryDate(t) }}</span>
              </div>

              <div class="summary-row d-flex justify-content-between mb-1">
                <span class="label text-muted">
                  {{ isAr() ? 'Ø§Ù„ÙˆÙ‚Øª' : 'Time' }}
                </span>
                <span class="value">{{ summaryTime(t) }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
