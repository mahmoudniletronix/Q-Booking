<div class="container schedule-page">
  <div class="card schedule-card shadow-sm border-0">
    <div class="card-body p-2 p-md-3">
      <!-- Filters -->
      <div class="row g-2 align-items-end filters-row flex-wrap">
        <!-- Branch -->
        <div class="col-xl-3 col-lg-3 col-md-3 col-sm-6 col-12">
          <label class="form-label small mb-1">Branch</label>
          <select
            class="form-select form-select-sm"
            [ngModel]="sch.selectedBranchId()"
            (ngModelChange)="onBranchChange($event)"
          >
            <option [ngValue]="null" disabled>Choose branch...</option>
            <option *ngFor="let b of branches" [ngValue]="b.id">
              {{ b.name }}
            </option>
          </select>
        </div>

        <!-- Specialization -->
        <div class="col-xl-3 col-lg-3 col-md-3 col-sm-6 col-12">
          <label class="form-label small mb-1">Specialization</label>
          <select
            class="form-select form-select-sm"
            [ngModel]="sch.selectedClinicId()"
            (ngModelChange)="onSpecializationChange($event)"
            [disabled]="!sch.selectedBranchId() || clinicsLoading"
          >
            <option [ngValue]="null" disabled>
              {{
                sch.selectedBranchId()
                  ? clinicsLoading
                    ? 'Loading...'
                    : 'Select specialization...'
                  : 'Select a branch first'
              }}
            </option>
            <ng-container *ngIf="sch.selectedBranchId() && !clinicsLoading">
              <option *ngFor="let c of sch.clinics" [ngValue]="c.id">
                {{ c.name }}
              </option>
            </ng-container>
          </select>
        </div>

        <!-- Operator -->
        <div class="col-xl-3 col-lg-3 col-md-3 col-sm-6 col-12">
          <label class="form-label small mb-1">Operator</label>
          <select
            class="form-select form-select-sm"
            [(ngModel)]="filter.operatorId"
            (ngModelChange)="onOperatorChange($event)"
            [disabled]="!sch.selectedClinicId()"
          >
            <option [ngValue]="'all'">All operators</option>
            <option
              *ngFor="let d of filteredClinicDoctors; trackBy: trackByDoctor"
              [ngValue]="d.id"
            >
              {{ d.name }}
            </option>
          </select>
        </div>

        <!-- Local doctor search -->
        <div class="col-xl-3 col-lg-3 col-md-3 col-sm-6 col-12">
          <div class="d-flex justify-content-between align-items-center">
            <label class="form-label small mb-1 mb-0">Search</label>
            <button
              *ngIf="hasActiveFilters && sch.selectedClinicId()"
              type="button"
              class="btn btn-sm reset-link"
              (click)="resetFilters()"
            >
              <i class="bi bi-arrow-counterclockwise"></i>
              <span class="ms-1">Reset</span>
            </button>
          </div>
          <div class="input-group input-group-sm">
            <span class="input-group-text">
              <i class="bi bi-search"></i>
            </span>
            <input
              type="text"
              class="form-control"
              name="globalSearch"
              [(ngModel)]="filter.searchQuery"
              (ngModelChange)="onSearchChange($event)"
              placeholder="Search doctors by name..."
            />
          </div>
        </div>
      </div>

      <!-- Doctor Search Strips -->
      <div *ngIf="doctorSearchMode">
        <div class="fw-semibold mb-2">Search Results:</div>

        <div class="strip-grid">
          <div
            class="result-strip"
            *ngFor="let r of doctorSearchResults"
            (click)="openDoctorFromSearch(r)"
          >
            <div class="strip-main">
              <span class="strip-title">
                {{ r.serviceArabicName || r.serviceEnglishName }}
              </span>
            </div>

            <div class="strip-meta">
              <span class="badge bg-light text-dark">
                {{ r.parentServiceArabicName || r.parentServiceEnglishName }}
              </span>

              <span class="badge bg-primary-subtle text-primary">
                {{ r.branchNameAr || r.branchNameEn }}
              </span>
            </div>
          </div>
        </div>

        <div class="small text-muted mt-1">ÿßÿ∂ÿ∫ÿ∑ ŸÑŸÅÿ™ÿ≠ ÿ¨ÿØŸàŸÑ ŸÖŸàÿßÿπŸäÿØ ÿßŸÑÿ∑ÿ®Ÿäÿ®</div>
      </div>

      <!-- ================= GLOBAL SEARCH STRIPS ================= -->
      <!-- ŸÑŸà ŸÅŸä ŸÜÿ™ÿßÿ¶ÿ¨ ÿ¨ŸÑŸàÿ®ÿßŸÑ ÿ≥Ÿäÿ±ÿ¥: ÿßÿπÿ±ÿ∂ strips ŸÖŸÉÿßŸÜ ÿßŸÑÿ¨ÿØŸàŸÑ -->
      <div *ngIf="searchStripMode && globalSearchResults.length; else scheduleContent">
        <div class="search-strips mb-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="fw-semibold">
              Search Results:
              <span class="text-primary">
                "{{ globalSearchQuery }}" ({{ globalSearchResults.length }} result{{
                  globalSearchResults.length > 1 ? 's' : ''
                }})
              </span>
            </div>

            <button
              type="button"
              class="btn btn-sm btn-outline-secondary"
              (click)="exitSearchMode()"
            >
              ‚¨Ö Back to Schedule
            </button>
          </div>

          <div class="strip-grid">
            <div
              class="result-strip"
              *ngFor="let r of globalSearchResults"
              (click)="openSearchTicketPopup(r)"
            >
              <div class="strip-main">
                <div>
                  <span class="strip-title">
                    {{ r.patientName || 'ÿ®ÿØŸàŸÜ ÿßÿ≥ŸÖ ŸÖÿ±Ÿäÿ∂' }}
                  </span>
                  <span class="ms-3 phoneNumber" *ngIf="r.customerInput">
                    {{ r.customerInput }}
                  </span>

                  <span class="strip-ticket ms-2">#{{ r.number }}</span>
                </div>

                <div>
                  <span class="badge" [ngClass]="getStatusClass(r)">
                    {{ getStatusLabel(r) }}
                  </span>
                </div>
              </div>

              <div class="strip-meta">
                <span class="badge bg-light text-dark me-2">
                  Branch: {{ r.branchName }} (ID: {{ r.branchId }})
                </span>
                <span class="badge bg-light text-dark me-2">
                  Specialization: {{ r.serviceParentName }}
                </span>
                <span class="badge bg-primary-subtle text-primary">
                  Doctor: {{ r.serviceName }}
                </span>
              </div>

              <div class="strip-meta2">
                <span class="slotTime">
                  üìÖ {{ r.reservationDate | date : 'yyyy-MM-dd' }} ‚Äî üïí
                  {{ r.slotTime }}
                </span>
                <span class="mx-2" *ngIf="r.createDate">
                  ‚è±Ô∏è Created: {{ r.createDate | date : 'short' }}
                </span>
                <!-- <span *ngIf="r.phoneNumber">üìû {{ r.phoneNumber }}</span> -->
              </div>

              <div class="strip-meta3 mt-1">
                <!-- extra -->
              </div>
            </div>
          </div>

          <div class="small text-muted mt-1">
            Click on any strip to view all ticket details and available actions.
          </div>
        </div>
      </div>

      <!-- ================= SCHEDULE TABLE ================= -->
      <ng-template #scheduleContent>
        <!-- Schedule Table -->
        <div *ngIf="sch.selectedClinicId() as clinicId">
          <ng-container *ngIf="filteredClinicDoctors.length > 0; else noResults">
            <div class="schedule-wrap">
              <div class="table-responsive rounded-3 border schedule-viewport">
                <div class="month-nav">
                  <button
                    type="button"
                    class="btn btn-light btn-sm nav-arrow"
                    (click)="prevMonth()"
                  >
                    <i class="bi bi-chevron-left"></i>
                  </button>

                  <div class="month-label fw-semibold">
                    {{ monthLabel }}
                  </div>

                  <button
                    type="button"
                    class="btn btn-light btn-sm nav-arrow"
                    (click)="nextMonth()"
                  >
                    <i class="bi bi-chevron-right"></i>
                  </button>
                </div>

                <table class="table table-bordered align-middle mb-0 schedule-table table-sm">
                  <thead class="table-light sticky-top">
                    <tr>
                      <th class="first-col sticky-col text-center">Day</th>
                      <th
                        *ngFor="let d of filteredClinicDoctors; trackBy: trackByDoctor"
                        class="text-center doctor-header sticky-top"
                      >
                        <div class="doctor-name" [title]="d.name">
                          {{ d.name }}
                        </div>
                      </th>
                    </tr>
                  </thead>

                  <tbody>
                    <tr *ngFor="let day of visibleDays; trackBy: trackByDay">
                      <th class="first-col sticky-col text-center">
                        {{ day.label }}
                      </th>

                      <td
                        *ngFor="let d of filteredClinicDoctors; trackBy: trackByDoctor"
                        class="text-center schedule-cell"
                      >
                        <ng-container *ngIf="counts(clinicId, d.id, day) as c">
                          <div class="stats-row" *ngIf="c.total > 0; else emptyCell">
                            <button
                              class="pill pill-reserved"
                              type="button"
                              [title]="c.reserved + ' reserved'"
                              (click)="onReservedClick(clinicId, d, day)"
                            >
                              <span class="num">{{ c.reserved }}</span>
                              <span class="label">Reserved</span>
                            </button>

                            <button
                              class="pill pill-available"
                              type="button"
                              [title]="'Available: ' + c.available"
                              (click)="onAvailableClick(clinicId, d, day)"
                            >
                              <span class="num">{{ c.available }}</span>
                              <span class="label">Available</span>
                            </button>
                          </div>
                        </ng-container>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </ng-container>
        </div>

        <ng-template #noResults>
          <div class="no-results text-center text-muted py-5">
            ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨ ŸÖÿ∑ÿßÿ®ŸÇÿ© ŸÑÿ®ÿ≠ÿ´ŸÉ. ÿ¨ÿ±Ÿëÿ® ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ®ÿ≠ÿ´
          </div>
        </ng-template>

        <ng-template #emptyCell>
          <div class="empty-cell">-</div>
        </ng-template>
      </ng-template>

      <!-- ============= POPUPFOR GLOBAL SEARCH TICKET ============= -->
      <div class="search-modal-backdrop" *ngIf="searchPopupOpen && selectedSearchTicket as p">
        <div class="search-modal">
          <div class="modal-header d-flex justify-content-between align-items-center mb-2">
            <div>
              <div class="fw-semibold">Ticket #{{ p.number }}</div>
              <div class="text-muted small">
                {{ p.patientName || p.serviceName || p.phoneNumber }}
              </div>
            </div>
            <button
              type="button"
              class="btn btn-sm btn-outline-secondary"
              (click)="closeSearchTicketPopup()"
            >
              ‚úï
            </button>
          </div>

          <div class="modal-body">
            <div class="row g-2">
              <div class="col-6">
                <div class="label">Ticket ID</div>
                <div class="value">{{ p.id }}</div>
              </div>

              <div class="col-6">
                <div class="label">Status</div>
                <div class="value">
                  <span class="badge" [ngClass]="getStatusClass(p)">
                    {{ getStatusLabel(p) }}
                  </span>
                </div>
              </div>

              <div class="col-6">
                <div class="label">Branch</div>
                <div class="value">{{ p.branchName }} (ID: {{ p.branchId }})</div>
              </div>

              <div class="col-6">
                <div class="label">Specialization</div>
                <div class="value">{{ p.serviceParentName }}</div>
              </div>

              <div class="col-6">
                <div class="label">Doctor</div>
                <div class="value">{{ p.serviceName }} (ID: {{ p.serviceId }})</div>
              </div>

              <div class="col-6">
                <div class="label">Reservation date</div>
                <div class="value">
                  {{ p.reservationDate | date : 'yyyy-MM-dd' }} ‚Äî {{ p.slotTime }}
                </div>
              </div>

              <div class="col-6" *ngIf="p.createDate">
                <div class="label">Created at</div>
                <div class="value">
                  {{ p.createDate | date : 'short' }}
                </div>
              </div>

              <div class="col-6" *ngIf="p.serviceWorkFlow">
                <div class="label">Workflow</div>
                <div class="value">{{ p.serviceWorkFlow }}</div>
              </div>

              <div class="col-6">
                <div class="label">Patient</div>
                <div class="value">
                  {{ p.patientName || 'ÿ®ÿØŸàŸÜ ÿßÿ≥ŸÖ' }}
                </div>
              </div>

              <div class="col-6">
                <div class="label">Phone</div>
                <div class="value">
                  {{ p.phoneNumber || '‚Äî' }}
                </div>
              </div>

              <div class="col-12" *ngIf="p.customerInput">
                <div class="label">Note</div>
                <div class="value">{{ p.customerInput }}</div>
              </div>
            </div>
          </div>

          <div class="modal-footer d-flex gap-2 mt-3">
            <button
              type="button"
              class="btn btn-sm btn-primary flex-fill"
              (click)="editSearchTicket(p)"
              [disabled]="isMissedTicket(p)"
            >
              Edit ticket
            </button>

            <button
              type="button"
              class="btn btn-sm btn-success flex-fill"
              (click)="printSearchTicket(p)"
              [disabled]="isMissedTicket(p) && isTicketActionsDisabled(p)"
            >
              Print
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
