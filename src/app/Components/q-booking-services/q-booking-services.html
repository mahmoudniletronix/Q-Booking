<div class="container schedule-page">
  <div class="card schedule-card shadow-sm border-0">
    <div class="card-body p-2 p-md-3">
      <!-- Filters -->
      <div class="row g-2 align-items-end filters-row flex-wrap">
        <!-- Branch -->
        <div class="col-xl-3 col-lg-3 col-md-3 col-sm-6 col-12">
          <label class="form-label small mb-1">Branch</label>
          <select
            class="form-select form-select-sm"
            [ngModel]="selectedBranchId"
            (ngModelChange)="onBranchChange($event)"
          >
            <option [ngValue]="null" disabled>Choose branch...</option>
            <option *ngFor="let b of branches" [ngValue]="b.id">
              {{ b.name }}
            </option>
          </select>
        </div>

        <!-- Specialization -->
        <div class="col-xl-3 col-lg-3 col-md-3 col-sm-6 col-12">
          <label class="form-label small mb-1">Specialization</label>
          <select
            class="form-select form-select-sm"
            [ngModel]="sch.selectedClinicId()"
            (ngModelChange)="onSpecializationChange($event)"
          >
            <option [ngValue]="null" disabled>Select specialization...</option>
            <option *ngFor="let c of sch.clinics" [ngValue]="c.id">
              {{ c.name }}
            </option>
          </select>
        </div>

        <!-- Operator -->
        <div class="col-xl-3 col-lg-3 col-md-3 col-sm-6 col-12">
          <label class="form-label small mb-1">Operator</label>
          <select
            class="form-select form-select-sm"
            [ngModel]="filter.operatorId"
            (ngModelChange)="onOperatorChange($event)"
            [disabled]="!sch.selectedClinicId()"
          >
            <option [ngValue]="'all'">All operators</option>
            <option
              *ngFor="let d of selectedClinicDoctors; trackBy: trackByDoctor"
              [ngValue]="d.id"
            >
              {{ d.name }}
            </option>
          </select>
        </div>

        <!-- Search + Reset -->
        <div class="col-xl-3 col-lg-3 col-md-3 col-sm-6 col-12">
          <div class="d-flex justify-content-between align-items-center">
            <label class="form-label small mb-1 mb-0">Search</label>
            <button
              *ngIf="hasActiveFilters && sch.selectedClinicId()"
              type="button"
              class="btn btn-sm reset-link"
              (click)="resetFilters()"
            >
              <i class="bi bi-arrow-counterclockwise"></i>
              <span class="ms-1">Reset</span>
            </button>
          </div>
          <div class="input-group input-group-sm">
            <span class="input-group-text">
              <i class="bi bi-search"></i>
            </span>
            <input
              type="text"
              class="form-control"
              name="globalSearch"
              [(ngModel)]="filter.searchQuery"
              placeholder="Search by doctor, day, or status..."
            />
          </div>
        </div>
      </div>

      <!-- Legend -->
      <div class="row g-2 mb-2 align-items-center filters-row" *ngIf="sch.selectedClinicId()">
        <div class="col-12">
          <div class="legend-wrap">
            <label class="legend-item">
              <input type="checkbox" [(ngModel)]="filter.reservedChecked" />
              <span class="legend-box reserved"></span>
              <span>Reserved</span>
            </label>

            <label class="legend-item">
              <input type="checkbox" [(ngModel)]="filter.availableChecked" />
              <span class="legend-box available"></span>
              <span>Available</span>
            </label>
          </div>
        </div>
      </div>

      <!-- Schedule Table -->
      <div *ngIf="sch.selectedClinicId() as clinicId" class="schedule-wrap">
        <div class="table-responsive rounded-3 border schedule-viewport">
          <div class="month-nav">
            <button type="button" class="btn btn-light btn-sm nav-arrow" (click)="prevMonth()">
              <i class="bi bi-chevron-left"></i>
            </button>

            <div class="month-label fw-semibold">
              {{ monthLabel }}
            </div>

            <button type="button" class="btn btn-light btn-sm nav-arrow" (click)="nextMonth()">
              <i class="bi bi-chevron-right"></i>
            </button>
          </div>

          <table class="table table-bordered align-middle mb-0 schedule-table table-sm">
            <thead class="table-light sticky-top">
              <tr>
                <th class="first-col sticky-col text-center">Day</th>
                <th
                  *ngFor="let d of filteredClinicDoctors; trackBy: trackByDoctor"
                  class="text-center doctor-header sticky-top"
                >
                  <div class="doctor-name" [title]="d.name">
                    {{ d.name }}
                  </div>
                  <div class="doctor-meta small text-muted">30 min / slot</div>
                </th>
              </tr>
            </thead>

            <tbody>
              <tr *ngFor="let day of visibleDays; trackBy: trackByDay">
                <th class="first-col sticky-col text-center">
                  {{ day.label }}
                </th>

                <td
                  *ngFor="let d of filteredClinicDoctors; trackBy: trackByDoctor"
                  class="text-center schedule-cell"
                >
                  <ng-container *ngIf="counts(clinicId, d.id, day) as c">
                    <div class="stats-row" *ngIf="c.total > 0; else emptyCell">
                      <button
                        *ngIf="filter.reservedChecked"
                        class="pill pill-reserved"
                        type="button"
                        [title]="c.reserved + ' reserved'"
                        (click)="onReservedClick(clinicId, d, day)"
                      >
                        <span class="num">{{ c.reserved }}</span>
                        <span class="label">Reserved</span>
                      </button>

                      <button
                        *ngIf="filter.availableChecked"
                        class="pill pill-available"
                        type="button"
                        [title]="'Available: ' + c.available"
                        (click)="onAvailableClick(clinicId, d, day)"
                      >
                        <span class="num">{{ c.available }}</span>
                        <span class="label">Available</span>
                      </button>
                    </div>
                  </ng-container>
                </td>
              </tr>

              <tr *ngIf="filteredClinicDoctors.length === 0">
                <td colspan="99" class="text-center small text-muted py-3">
                  No doctors match the current filters. Try adjusting search, operator, or legend.
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div *ngIf="!sch.selectedClinicId()" class="text-center text-muted py-4 small">
        Select branch & specialization to view the schedule.
      </div>
    </div>
  </div>
</div>

<ng-template #emptyCell>
  <div class="empty-cell">-</div>
</ng-template>
