<div class="container schedule-page">
  <div class="card schedule-card shadow-sm border-0">
    <div class="card-body p-2 p-md-3">
      <!-- Filters -->
      <div class="row g-2 align-items-end filters-row flex-wrap">
        <!-- Branch -->
        <div class="col-xl-3 col-lg-3 col-md-3 col-sm-6 col-12">
          <label class="form-label small mb-1">
            {{ isAr() ? 'Ø§Ù„ÙØ±Ø¹' : 'Branch' }}
          </label>
          <select
            class="form-select form-select-sm"
            [ngModel]="sch.selectedBranchId()"
            (ngModelChange)="onBranchChange($event)"
          >
            <option [ngValue]="null" disabled>
              {{ isAr() ? 'Ø§Ø®ØªØ± ÙØ±Ø¹Ù‹Ø§...' : 'Choose branch...' }}
            </option>
            <option *ngFor="let b of branches" [ngValue]="b.id">
              {{ b.name }}
            </option>
          </select>
        </div>

        <!-- Specialization -->
        <div class="col-xl-3 col-lg-3 col-md-3 col-sm-6 col-12">
          <label class="form-label small mb-1">
            {{ isAr() ? 'Ø§Ù„ØªØ®ØµØµ' : 'Specialization' }}
          </label>
          <select
            class="form-select form-select-sm"
            [ngModel]="sch.selectedClinicId()"
            (ngModelChange)="onSpecializationChange($event)"
            [disabled]="!sch.selectedBranchId() || clinicsLoading"
          >
            <option [ngValue]="null" disabled>
              {{
                sch.selectedBranchId()
                  ? clinicsLoading
                    ? isAr()
                      ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...'
                      : 'Loading...'
                    : isAr()
                    ? 'Ø§Ø®ØªØ± ØªØ®ØµØµÙ‹Ø§...'
                    : 'Select specialization...'
                  : isAr()
                  ? 'Ø§Ø®ØªØ± ÙØ±Ø¹Ù‹Ø§ Ø£ÙˆÙ„Ø§Ù‹'
                  : 'Select a branch first'
              }}
            </option>
            <ng-container *ngIf="sch.selectedBranchId() && !clinicsLoading">
              <option *ngFor="let c of sch.clinics" [ngValue]="c.id">
                {{ c.name }}
              </option>
            </ng-container>
          </select>
        </div>

        <!-- Operator -->
        <div class="col-xl-3 col-lg-3 col-md-3 col-sm-6 col-12">
          <label class="form-label small mb-1">
            {{ isAr() ? 'Ø§Ù„Ø·Ø¨ÙŠØ¨' : 'Operator' }}
          </label>
          <select
            class="form-select form-select-sm"
            [(ngModel)]="filter.operatorId"
            (ngModelChange)="onOperatorChange($event)"
            [disabled]="!sch.selectedClinicId()"
          >
            <option [ngValue]="'all'">
              {{ isAr() ? 'ÙƒÙ„ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡' : 'All operators' }}
            </option>
            <option
              *ngFor="let d of filteredClinicDoctors; trackBy: trackByDoctor"
              [ngValue]="d.id"
            >
              {{ d.name }}
            </option>
          </select>
        </div>

        <!-- Local doctor search + Reset -->
        <div class="col-xl-3 col-lg-3 col-md-3 col-sm-6 col-12">
          <div class="d-flex justify-content-between align-items-center">
            <label class="form-label small mb-1 mb-0">
              {{ isAr() ? 'Ø¨Ø­Ø«' : 'Search' }}
            </label>

            <button
              type="button"
              class="btn btn-sm reset-link ms-2 mb-2"
              *ngIf="hasAnySelection"
              (click)="resetFilters()"
            >
              <i class="bi bi-x-circle"></i>
              <span class="ms-1">{{ isAr() ? 'Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†' : 'Reset' }}</span>
            </button>
          </div>

          <div class="input-group input-group-sm">
            <span class="input-group-text">
              <i class="bi bi-search"></i>
            </span>
            <input
              type="text"
              class="form-control"
              name="globalSearch"
              [(ngModel)]="filter.searchQuery"
              (ngModelChange)="onSearchChange($event)"
              [placeholder]="isAr() ? 'Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø¨Ø§Ù„Ø§Ø³Ù…...' : 'Search doctors by name...'"
            />
          </div>
        </div>
      </div>

      <!-- Doctor Search Strips -->
      <div *ngIf="doctorSearchMode">
        <div class="fw-semibold mb-2">
          {{ isAr() ? 'Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«:' : 'Search Results:' }}
        </div>

        <div class="strip-grid">
          <div
            class="result-strip"
            *ngFor="let r of doctorSearchResults"
            (click)="openDoctorFromSearch(r)"
          >
            <div class="strip-main">
              <span class="strip-title">
                {{ r.serviceArabicName || r.serviceEnglishName }}
              </span>
            </div>

            <div class="strip-meta">
              <span class="badge bg-light text-dark">
                {{ r.parentServiceArabicName || r.parentServiceEnglishName }}
              </span>

              <span class="badge bg-primary-subtle text-primary">
                {{ r.branchNameAr || r.branchNameEn }}
              </span>
            </div>
          </div>
        </div>

        <div class="small text-muted mt-1">
          {{ isAr() ? 'Ø§Ø¶ØºØ· Ù„ÙØªØ­ Ø¬Ø¯ÙˆÙ„ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø·Ø¨ÙŠØ¨' : 'Click to open the doctor schedule.' }}
        </div>
      </div>

      <!-- ================= GLOBAL SEARCH STRIPS ================= -->
      <div *ngIf="searchStripMode && globalSearchResults.length; else scheduleContent">
        <div class="search-strips mb-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="fw-semibold">
              {{ isAr() ? 'Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«:' : 'Search Results:' }}
              <span class="text-primary">
                â€œ{{ globalSearchQuery }}â€ ({{ globalSearchResults.length }}
                {{
                  isAr()
                    ? globalSearchResults.length > 1
                      ? 'Ù†ØªØ§Ø¦Ø¬'
                      : 'Ù†ØªÙŠØ¬Ø©'
                    : globalSearchResults.length > 1
                    ? 'results'
                    : 'result'
                }})
              </span>
            </div>

            <button
              type="button"
              class="btn btn-sm btn-outline-secondary"
              (click)="exitSearchMode()"
            >
              {{ isAr() ? 'â¬… Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø¬Ø¯ÙˆÙ„' : 'â¬… Back to Schedule' }}
            </button>
          </div>

          <div class="strip-grid">
            <div
              class="result-strip"
              *ngFor="let r of globalSearchResults"
              (click)="openSearchTicketPopup(r)"
            >
              <div class="strip-main">
                <div>
                  <span class="strip-title">
                    {{ r.patientName || (isAr() ? 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù… Ù…Ø±ÙŠØ¶' : 'No patient name') }}
                  </span>
                  <span class="ms-3 phoneNumber" *ngIf="r.customerInput">
                    {{ r.customerInput }}
                  </span>

                  <span class="strip-ticket ms-2">#{{ r.number }}</span>
                </div>

                <div>
                  <span class="badge" [ngClass]="getStatusClass(r)">
                    {{ getStatusLabel(r) }}
                  </span>
                </div>
              </div>

              <div class="strip-meta">
                <span class="badge bg-light text-dark me-2">
                  {{ isAr() ? 'Ø§Ù„ÙØ±Ø¹' : 'Branch' }}: {{ r.branchName }} (ID: {{ r.branchId }})
                </span>
                <span class="badge bg-light text-dark me-2">
                  {{ isAr() ? 'Ø§Ù„ØªØ®ØµØµ' : 'Specialization' }}: {{ r.serviceParentName }}
                </span>
                <span class="badge bg-primary-subtle text-primary">
                  {{ isAr() ? 'Ø§Ù„Ø·Ø¨ÙŠØ¨' : 'Doctor' }}: {{ r.serviceName }}
                </span>
              </div>

              <div class="strip-meta2">
                <span class="slotTime">
                  ğŸ“… {{ r.reservationDate | date : 'yyyy-MM-dd' }} â€” ğŸ•’
                  {{ r.slotTime }}
                </span>
                <span class="mx-2" *ngIf="r.createDate">
                  â±ï¸
                  {{ isAr() ? 'Ø£ÙÙ†Ø´Ø¦Øª:' : 'Created:' }}
                  {{ r.createDate | date : 'short' }}
                </span>
              </div>

              <div class="strip-meta3 mt-1">
                <!-- extra -->
              </div>
            </div>
          </div>

          <div class="small text-muted mt-1">
            {{
              isAr()
                ? 'Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ Ø¹Ù†ØµØ± Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ°ÙƒØ±Ø© ÙˆØ§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©.'
                : 'Click on any strip to view all ticket details and available actions.'
            }}
          </div>
        </div>
      </div>

      <!-- ================= SCHEDULE TABLE ================= -->
      <ng-template #scheduleContent>
        <div *ngIf="sch.selectedClinicId() as clinicId">
          <ng-container *ngIf="filteredClinicDoctors.length > 0; else noResults">
            <div class="schedule-wrap">
              <div class="table-responsive rounded-3 border schedule-viewport">
                <div class="month-nav">
                  <button
                    type="button"
                    class="btn btn-light btn-sm nav-arrow"
                    (click)="prevMonth()"
                  >
                    <i class="bi bi-chevron-left"></i>
                  </button>

                  <div class="month-label fw-semibold">
                    {{ monthLabel }}
                  </div>

                  <button
                    type="button"
                    class="btn btn-light btn-sm nav-arrow"
                    (click)="nextMonth()"
                  >
                    <i class="bi bi-chevron-right"></i>
                  </button>
                </div>

                <table class="table table-bordered align-middle mb-0 schedule-table table-sm">
                  <thead class="table-light sticky-top">
                    <tr>
                      <th class="first-col sticky-col text-center">
                        {{ isAr() ? 'Ø§Ù„ÙŠÙˆÙ…' : 'Day' }}
                      </th>
                      <th
                        *ngFor="let d of filteredClinicDoctors; trackBy: trackByDoctor"
                        class="text-center doctor-header sticky-top"
                      >
                        <div class="doctor-name" [title]="d.name">
                          {{ d.name }}
                        </div>
                      </th>
                    </tr>
                  </thead>

                  <tbody>
                    <tr *ngFor="let day of visibleDays; trackBy: trackByDay">
                      <th class="first-col sticky-col text-center">
                        {{ day.label }}
                      </th>

                      <td
                        *ngFor="let d of filteredClinicDoctors; trackBy: trackByDoctor"
                        class="text-center schedule-cell"
                      >
                        <ng-container *ngIf="counts(clinicId, d.id, day) as c">
                          <div class="stats-row" *ngIf="c.total > 0; else emptyCell">
                            <button
                              class="pill pill-reserved"
                              type="button"
                              [title]="isAr() ? c.reserved + ' Ù…Ø­Ø¬ÙˆØ²' : c.reserved + ' reserved'"
                              (click)="onReservedClick(clinicId, d, day)"
                            >
                              <span class="num">{{ c.reserved }}</span>
                              <span class="label">
                                {{ isAr() ? 'Ù…Ø­Ø¬ÙˆØ²' : 'Reserved' }}
                              </span>
                            </button>

                            <button
                              class="pill pill-available"
                              type="button"
                              [title]="
                                isAr() ? 'Ù…ØªØ§Ø­: ' + c.available : 'Available: ' + c.available
                              "
                              (click)="onAvailableClick(clinicId, d, day)"
                            >
                              <span class="num">{{ c.available }}</span>
                              <span class="label">
                                {{ isAr() ? 'Ù…ØªØ§Ø­' : 'Available' }}
                              </span>
                            </button>
                          </div>
                        </ng-container>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </ng-container>
        </div>

        <ng-template #noResults>
          <div class="no-results text-center text-muted py-5">
            {{
              isAr()
                ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ø¨Ø­Ø«Ùƒ. Ø¬Ø±Ù‘Ø¨ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ø­Ø«.'
                : 'No matching results for your search. Try adjusting the filters.'
            }}
          </div>
        </ng-template>

        <ng-template #emptyCell>
          <div class="empty-cell">-</div>
        </ng-template>
      </ng-template>

      <!-- ============= POPUP FOR GLOBAL SEARCH TICKET ============= -->
      <div class="search-modal-backdrop" *ngIf="searchPopupOpen && selectedSearchTicket as p">
        <div class="search-modal">
          <div class="modal-header d-flex justify-content-between align-items-center mb-2">
            <div>
              <div class="fw-semibold">{{ isAr() ? 'ØªØ°ÙƒØ±Ø© Ø±Ù‚Ù…' : 'Ticket #' }}{{ p.number }}</div>
              <div class="text-muted small">
                {{ p.patientName || p.serviceName || p.phoneNumber }}
              </div>
            </div>
            <button
              type="button"
              class="btn btn-sm btn-outline-secondary"
              (click)="closeSearchTicketPopup()"
            >
              âœ•
            </button>
          </div>

          <div class="modal-body">
            <div class="row g-2">
              <div class="col-6">
                <div class="label">
                  {{ isAr() ? 'Ù…Ø¹Ø±Ù‘Ù Ø§Ù„ØªØ°ÙƒØ±Ø©' : 'Ticket ID' }}
                </div>
                <div class="value">{{ p.id }}</div>
              </div>

              <div class="col-6">
                <div class="label">
                  {{ isAr() ? 'Ø§Ù„Ø­Ø§Ù„Ø©' : 'Status' }}
                </div>
                <div class="value">
                  <span class="badge" [ngClass]="getStatusClass(p)">
                    {{ getStatusLabel(p) }}
                  </span>
                </div>
              </div>

              <div class="col-6">
                <div class="label">
                  {{ isAr() ? 'Ø§Ù„ÙØ±Ø¹' : 'Branch' }}
                </div>
                <div class="value">{{ p.branchName }} (ID: {{ p.branchId }})</div>
              </div>

              <div class="col-6">
                <div class="label">
                  {{ isAr() ? 'Ø§Ù„ØªØ®ØµØµ' : 'Specialization' }}
                </div>
                <div class="value">{{ p.serviceParentName }}</div>
              </div>

              <div class="col-6">
                <div class="label">
                  {{ isAr() ? 'Ø§Ù„Ø·Ø¨ÙŠØ¨' : 'Doctor' }}
                </div>
                <div class="value">{{ p.serviceName }}</div>
              </div>

              <div class="col-6">
                <div class="label">
                  {{ isAr() ? 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø²' : 'Reservation date' }}
                </div>
                <div class="value">
                  {{ p.reservationDate | date : 'yyyy-MM-dd' }} â€” {{ p.slotTime }}
                </div>
              </div>

              <div class="col-6" *ngIf="p.createDate">
                <div class="label">
                  {{ isAr() ? 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡' : 'Created at' }}
                </div>
                <div class="value">
                  {{ p.createDate | date : 'short' }}
                </div>
              </div>

              <div class="col-6">
                <div class="label">
                  {{ isAr() ? 'Ø§Ù„Ù…Ø±ÙŠØ¶' : 'Patient' }}
                </div>
                <div class="value">
                  {{ p.patientName || (isAr() ? 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…' : 'No name') }}
                </div>
              </div>

              <div class="col-6">
                <div class="label">
                  {{ isAr() ? 'Ø§Ù„Ø¬ÙˆØ§Ù„' : 'Phone' }}
                </div>
                <div class="value">
                  {{ p.phoneNumber || 'â€”' }}
                </div>
              </div>
            </div>
          </div>

          <div class="modal-footer d-flex gap-2 mt-3">
            <button
              type="button"
              class="btn btn-sm btn-primary flex-fill"
              (click)="editSearchTicket(p)"
              [disabled]="isMissedTicket(p)"
            >
              {{ isAr() ? 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ°ÙƒØ±Ø©' : 'Edit ticket' }}
            </button>

            <button
              type="button"
              class="btn btn-sm btn-success flex-fill"
              (click)="printSearchTicket(p)"
              [disabled]="isMissedTicket(p) && isTicketActionsDisabled(p)"
            >
              {{ isAr() ? 'Ø·Ø¨Ø§Ø¹Ø©' : 'Print' }}
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
