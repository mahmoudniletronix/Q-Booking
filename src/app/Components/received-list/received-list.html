<div class="container my-4 reserved-page">
  <div class="row">
    <!-- LEFT: Tickets -->
    <div class="col-lg-9 col-12">
      <div class="header-wrap d-flex justify-content-between align-items-center mb-3 flex-wrap">
        <div class="d-flex align-items-center gap-3 flex-wrap">
          <button class="btn-back" (click)="back()">â†©</button>

          <div>
            <h5 class="title mb-0">
              {{ isAr() ? 'Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª' : 'Reserved' }}
              â€”
              {{ isAr() ? 'Ø§Ù„ÙŠÙˆÙ…' : 'Day' }} {{ dayLabel }}
            </h5>

            <!-- Ø§Ø³Ù… Ø§Ù„Ø¯ÙƒØªÙˆØ± -->
            <div class="sub text-primary fw-semibold" *ngIf="doctorName">
              {{ doctorName }}
            </div>

            <div class="sub">
              <ng-container *ngIf="isAr(); else enCount">
                <ng-container *ngIf="items.length; else noAr">
                  {{ items.length }} Ø­Ø¬Ø² Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ø¨ÙŠØ¨ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ….
                </ng-container>
                <ng-template #noAr>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ø¨ÙŠØ¨ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ….</ng-template>
              </ng-container>
              <ng-template #enCount>
                {{ items.length }}
                reservation{{ items.length !== 1 ? 's' : '' }} found for this doctor.
              </ng-template>
            </div>
          </div>
        </div>

        <div class="muted small-text" *ngIf="items.length">
          <ng-container *ngIf="isAr(); else enSelected">
            ØªÙ… Ø§Ø®ØªÙŠØ§Ø± {{ selectedIds.size }} Ù…Ù† {{ items.length }}
          </ng-container>
          <ng-template #enSelected> {{ selectedIds.size }} selected </ng-template>
        </div>
      </div>

      <!-- Tickets Grid -->
      <div *ngIf="items.length; else empty" class="res-grid">
        <div
          class="res-card"
          *ngFor="let t of items; trackBy: trackById"
          [class.selected]="selectedIds.has(t.id)"
          (click)="onTicketClick(t)"
          [attr.id]="'ticket-' + t.id"
          [class.focused]="focusedTicket?.id === t.id"
        >
          <div class="select-dot" *ngIf="selectedIds.has(t.id)">
            <div class="dot-inner"></div>
          </div>

          <div class="shine"></div>

          <div class="card-top">
            <div class="left">
              <span class="number text-dark fw-bold">{{ t.number }}</span>
            </div>

            <div class="right">
              <span class="time muted">{{ format12(t.timeSlot) }}</span>
            </div>
          </div>

          <div class="card-mid">
            <div class="patient muted text-truncate">{{ t.patientName }}</div>
            <div class="muted small-text">
              {{ t.phoneNumber }}
            </div>
          </div>
        </div>
      </div>

      <ng-template #empty>
        <div class="empty-state text-center mt-5">
          <div class="emoji">ğŸ“„</div>
          <div class="lead fw-semibold">
            {{ isAr() ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ….' : 'No reserved tickets for this day.' }}
          </div>
        </div>
      </ng-template>
    </div>

    <!-- RIGHT: Actions + Summary -->
    <div class="col-lg-3 d-none d-lg-block">
      <div class="actions-panel">
        <div class="panel-section">
          <div class="section-title">
            {{ isAr() ? 'Ø§Ù„ØªØ­Ø¯ÙŠØ¯' : 'Selection' }}
          </div>
          <div class="d-flex align-items-center justify-content-between mb-2">
            <div class="muted">
              <ng-container *ngIf="isAr(); else enSelInfo">
                Ø§Ù„Ù…Ø®ØªØ§Ø±:
                <strong>{{ selectedIds.size }}</strong> / {{ items.length }}
              </ng-container>
              <ng-template #enSelInfo>
                Selected: <strong>{{ selectedIds.size }}</strong> / {{ items.length }}
              </ng-template>
            </div>
            <div class="d-flex gap-1">
              <button
                type="button"
                class="btn btn-xs btn-outline-light"
                (click)="selectAll()"
                [disabled]="!items.length"
              >
                {{ isAr() ? 'Ø§Ù„ÙƒÙ„' : 'All' }}
              </button>
              <button
                type="button"
                class="btn btn-xs btn-outline-light"
                (click)="clearSelection()"
                [disabled]="!selectedIds.size"
              >
                {{ isAr() ? 'Ù…Ø³Ø­' : 'Clear' }}
              </button>
            </div>
          </div>
        </div>

        <!-- Change slot button / editor -->
        <button
          type="button"
          class="btn btn-xs btn-outline-light flex-fill bg-warning"
          *ngIf="focusedTicket && !editingSlot"
          (click)="startSlotEdit()"
          [disabled]="!canEditTicket(focusedTicket)"
        >
          {{ isAr() ? 'ØªØºÙŠÙŠØ± Ø§Ù„Ù…ÙˆØ¹Ø¯' : 'Change Slot' }}
        </button>

        <div class="d-flex align-items-center gap-2" *ngIf="editingSlot">
          <input type="time" class="form-control form-control-sm" [(ngModel)]="newSlotValue" />

          <button type="button" class="btn btn-sm btn-success" (click)="applySlotChange()">
            {{ isAr() ? 'Ø­ÙØ¸' : 'Save' }}
          </button>

          <button type="button" class="btn btn-sm btn-secondary" (click)="cancelSlotEdit()">
            {{ isAr() ? 'Ø¥Ù„ØºØ§Ø¡' : 'Cancel' }}
          </button>
        </div>

        <div class="panel-section">
          <div class="section-title">
            {{ isAr() ? 'Ù†Ù‚Ù„ Ø§Ù„ØªØ°Ø§ÙƒØ± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø¥Ù„Ù‰ Ø·Ø¨ÙŠØ¨ Ø¢Ø®Ø±' : 'Move selected to another doctor' }}
          </div>

          <select
            class="form-select form-select-sm mb-2"
            [ngModel]="targetDoctorId"
            (ngModelChange)="onTargetDoctorChange($event)"
          >
            <option [ngValue]="null" disabled>
              {{ isAr() ? 'Ø§Ø®ØªØ± Ø·Ø¨ÙŠØ¨Ù‹Ø§...' : 'Choose doctor...' }}
            </option>
            <option *ngFor="let d of targetDoctors" [ngValue]="d.id" [disabled]="d.id === doctorId">
              {{ d.name }}
            </option>
          </select>

          <div *ngIf="targetDoctorDays.length">
            <label class="form-label small mb-1">
              {{ isAr() ? 'Ø§Ù„ÙŠÙˆÙ… Ù„Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ù…Ø­Ø¯Ø¯' : 'Day for selected doctor' }}
            </label>

            <select
              class="form-select form-select-sm"
              [(ngModel)]="selectedTargetDay"
              (ngModelChange)="onTargetDayChange($event)"
            >
              <option [ngValue]="null" disabled>
                {{ isAr() ? 'Ø§Ø®ØªØ± Ø§Ù„ÙŠÙˆÙ…...' : 'Choose day...' }}
              </option>
              <option *ngFor="let d of targetDoctorDays" [ngValue]="d.dateYmd">
                {{ d.dayText }} â€” {{ d.startText }} â€”
                {{
                  isAr()
                    ? d.reserved + ' Ù…Ø­Ø¬ÙˆØ² / ' + d.available + ' Ù…ØªØ§Ø­'
                    : d.reserved + ' Reserved / ' + d.available + ' Available'
                }}
              </option>
            </select>

            <div class="mt-2" *ngIf="selectedTargetDay">
              <ng-container *ngFor="let d of targetDoctorDays">
                <ng-container *ngIf="d.dateYmd === selectedTargetDay">
                  <span class="badge-status badge-reserved">
                    {{ isAr() ? d.reserved + ' Ù…Ø­Ø¬ÙˆØ²' : d.reserved + ' Reserved' }}
                  </span>
                  <span class="badge-status badge-available">
                    {{ isAr() ? d.available + ' Ù…ØªØ§Ø­' : d.available + ' Available' }}
                  </span>
                </ng-container>
              </ng-container>
            </div>
          </div>

          <div
            class="mt-2"
            *ngIf="selectedIds.size === 1 && selectedTargetDay && targetDaySlots.length"
          >
            <label class="form-label small mb-1">
              {{ isAr() ? 'Ù…ÙˆØ¹Ø¯ Ø§Ù„ØªØ°ÙƒØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©' : 'Slot for selected ticket' }}
            </label>

            <select class="form-select form-select-sm" [(ngModel)]="selectedTargetSlot">
              <option [ngValue]="null" disabled>
                {{ isAr() ? 'Ø§Ø®ØªØ± Ù…ÙˆØ¹Ø¯Ù‹Ø§...' : 'Choose slot...' }}
              </option>
              <option *ngFor="let s of targetDaySlots" [ngValue]="s">
                {{ format12(s) }}
              </option>
            </select>
          </div>

          <div
            class="mt-2"
            *ngIf="selectedIds.size > 1 && selectedTargetDay && targetDaySlots.length"
          >
            <label class="form-label small mb-1">
              {{ isAr() ? 'Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ù„Ù„ØªØ°Ø§ÙƒØ± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©' : 'Slots for selected tickets' }}
            </label>

            <div
              class="d-flex align-items-center gap-2 mb-1 ticket-slot-row"
              *ngFor="let t of selectedTickets"
            >
              <div class="small text-muted" style="min-width: 120px">
                {{ t.number }} â€” {{ format12(t.timeSlot) }}
              </div>

              <select class="form-select form-select-sm" [(ngModel)]="ticketMoveSlots[t.id]">
                <option [ngValue]="null" disabled>
                  {{ isAr() ? 'Ø§Ø®ØªØ± Ù…ÙˆØ¹Ø¯Ù‹Ø§...' : 'Choose slot...' }}
                </option>
                <option *ngFor="let s of targetDaySlots" [ngValue]="s">
                  {{ format12(s) }}
                </option>
              </select>
            </div>
          </div>

          <button
            type="button"
            class="btn btn-sm btn-move w-100 mt-2"
            [disabled]="!canMove()"
            (click)="moveSelected()"
          >
            {{
              isAr()
                ? 'Ù†Ù‚Ù„ ' + selectedIds.size + ' ØªØ°ÙƒØ±Ø©'
                : 'Move selected (' + selectedIds.size + ')'
            }}
          </button>
        </div>

        <div class="panel-section">
          <div class="section-title">
            {{ isAr() ? 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©' : 'Cancel selected reservations' }}
          </div>
          <textarea
            class="form-control form-control-sm mb-2"
            rows="2"
            [placeholder]="isAr() ? 'Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù„ØºØ§Ø¡...' : 'Write cancel reason...'"
            [(ngModel)]="cancelNote"
          ></textarea>
          <button
            type="button"
            class="btn btn-sm btn-cancel w-100"
            [disabled]="!canCancel()"
            (click)="cancelSelected()"
          >
            {{
              isAr()
                ? 'Ø¥Ù„ØºØ§Ø¡ ' + selectedIds.size + ' Ø­Ø¬Ø²'
                : 'Cancel selected (' + selectedIds.size + ')'
            }}
          </button>
        </div>

        <div class="panel-section" *ngIf="focusedTicket && selectedIds.size === 1">
          <div class="section-title">
            {{ isAr() ? 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ°ÙƒØ±Ø©' : 'Ticket details' }}
          </div>
          <div class="ticket-summary">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <div class="badge-number">{{ focusedTicket.number }}</div>
              <span class="time-pill">{{ format12(focusedTicket.timeSlot) }}</span>
            </div>
            <div class="summary-line">
              <span class="label">{{ isAr() ? 'Ø§Ù„Ù…Ø±ÙŠØ¶:' : 'Patient:' }}</span>
              <span class="value">{{ focusedTicket.patientName }}</span>
            </div>
            <div class="summary-line">
              <span class="label">{{ isAr() ? 'Ø§Ù„Ø¬ÙˆØ§Ù„:' : 'Phone:' }}</span>
              <span class="value">{{ focusedTicket.phoneNumber }}</span>
            </div>
            <div class="summary-line">
              <span class="label">{{ isAr() ? 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡:' : 'Created:' }}</span>
              <span class="value">{{ focusedTicket.createDate | date : 'short' }}</span>
            </div>
            <div class="summary-line" *ngIf="focusedTicket.customerInput">
              <span class="label">{{ isAr() ? 'Ù…Ù„Ø§Ø­Ø¸Ø©:' : 'Note:' }}</span>
              <span class="value">{{ focusedTicket.customerInput }}</span>
            </div>

            <div class="d-flex gap-2 mt-3">
              <button
                type="button"
                class="btn btn-xs btn-outline-light flex-fill bg-primary"
                (click)="printTicket(focusedTicket)"
                [disabled]="!canPrintTicket(focusedTicket)"
              >
                {{ isAr() ? 'Ø·Ø¨Ø§Ø¹Ø©' : 'Print' }}
              </button>
            </div>

            <div class="mt-2 text-danger small" *ngIf="!canEditTicket(focusedTicket)">
              {{
                isAr()
                  ? 'Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ°ÙƒØ±Ø© Ø¨Ø¹Ø¯ Ù…Ø±ÙˆØ± ÙˆÙ‚Øª Ø§Ù„Ø­Ø¬Ø².'
                  : 'You cannot modify this ticket after its reservation time.'
              }}
            </div>
            <div class="mt-1 text-warning small" *ngIf="!canPrintTicket(focusedTicket)">
              {{
                isAr()
                  ? 'ÙŠÙ…ÙƒÙ† Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªØ°ÙƒØ±Ø© ÙÙŠ ÙŠÙˆÙ… Ø§Ù„Ø­Ø¬Ø² ÙÙ‚Ø·.'
                  : 'Tickets can only be printed on the reservation day.'
              }}
            </div>
          </div>
        </div>

        <div class="panel-empty" *ngIf="!focusedTicket && items.length && selectedIds.size <= 1">
          {{
            isAr()
              ? 'Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ ØªØ°ÙƒØ±Ø© ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„Ù‡Ø§ Ù‡Ù†Ø§.'
              : 'Click any ticket on the left to view details here.'
          }}
        </div>
      </div>
    </div>
  </div>
</div>
